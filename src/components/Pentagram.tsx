import { FC } from "react";
import { useTheme } from "react-native-paper";
import Svg, { Circle, G, Path, Text } from "react-native-svg";
import { PENTAGRAM_PREFERENCE } from "../constants";
import { InitialNote, InitialNoteMap, NoteName } from "../types";

const NOTE_MULTIPLIER: Record<NoteName, number> = {
  C: 0,
  D: 1,
  E: 2,
  F: 3,
  G: 4,
  A: 5,
  B: 6,
};

const getY = (note: InitialNote): number => {
  const penta = PENTAGRAM_PREFERENCE[note.section];
  const noteMultiplier = NOTE_MULTIPLIER[note.note.note];
  const onPenta = noteMultiplier * 10 + (note.note.octave - 1) * 70 + 40;
  const pos = penta === "high" ? 90 + onPenta : onPenta;

  return Math.round(pos);
};

const LINES = [20, 40, 60, 180, 200, 220, 230, 250, 270, 390, 410, 430];

const SingleNote: FC<{ note: InitialNote }> = ({ note }) => {
  const theme = useTheme();
  const penta = PENTAGRAM_PREFERENCE[note.section];
  const y = getY(note);
  let lines: number[] = [];
  if (penta === "low" && y <= 60) {
    lines.push(...LINES.filter((l) => l <= 60 && l >= y));
  }
  if (penta === "low" && y >= 180) {
    lines.push(...LINES.filter((l) => l >= 180 && l <= y));
  }
  if (penta === "high" && y <= 270) {
    lines.push(...LINES.filter((l) => l <= 270 && l >= y));
  }
  if (penta === "high" && y >= 390) {
    lines.push(...LINES.filter((l) => l >= 390 && l <= y));
  }

  return (
    <G>
      {[...new Set(lines)].map((line, i) => (
        <Path
          key={i}
          stroke={theme.colors.onSurface}
          strokeWidth={2}
          d={`m142 ${450 - line}h36`}
        />
      ))}
      <Circle
        cx={160}
        cy={450 - y}
        r={10}
        fill={theme.colors.onSurface}
        strokeWidth={1}
        stroke={theme.colors.onSurfaceVariant}
      />
      <Text
        x={180}
        y={456 - y}
        fontSize={16}
        fontFamily="serif"
        fontStyle="italic"
        fill={theme.colors.onSurfaceVariant}
      >
        {note.section.charAt(0).toUpperCase()}
        {note.section.slice(1, 3)}.
        {note.subsection ? ` ${note.subsection}` : ""}
      </Text>
      <Text
        x={125}
        y={460 - y}
        fontSize={30}
        fontStyle="italic"
        fill={theme.colors.onSurface}
      >
        {note.note.alteration}
      </Text>
    </G>
  );
};

export const Pentagram: FC<{ notes: InitialNoteMap }> = (props) => {
  const theme = useTheme();
  return (
    <Svg viewBox="0 0 250 450" width={125} height={225}>
      <Path
        fill={theme.colors.onSurfaceDisabled}
        stroke="none"
        d="m48.67 402.4c0.3253-0.238 0.5856-0.5638 0.5856-0.9647 0-0.1629-0.09112-0.3132-0.09112-0.4009-0.07804-0.2381-4.997-20.85-30.65-20.85h-10.16v8.345c0 0.6389 0.4945 1.04 1.171 1.04h13.24c15.92 0 24.24 12.35 24.41 12.59 0.1562 0.3132 0.5726 0.4009 0.9109 0.4009 0.1692 0 0.4164-0.0877 0.5857-0.1629m0-354.7c-0.1692-0.07523-0.4164-0.1629-0.5857-0.1629-0.3383 0-0.7548 0.08773-0.9109 0.4009-0.1692 0.2381-8.498 12.59-24.41 12.59h-13.24c-0.6767 0-1.171 0.4009-1.171 1.04v8.345h10.16c25.65 0 30.57-20.61 30.65-20.85 0-0.08773 0.09112-0.2381 0.09112-0.4009 0-0.4009-0.2603-0.7267-0.5856-0.9647m-40.32 17.71v319.3h9.37v-319.3zm59.27 224.5c-6.338 0-11.41 3.521-11.5 3.521-4.906 3.446-8.069 8.746-8.069 14.6 0 5.852 3.488 10.19 9.656 10.19 5.336 0 9.5-3.446 9.5-8.746 0-4.573-4.164-8.332-8.836-8.332-1.002 0-1.913 0.1504-2.668 0.4009-0.8329 0.3133-2.238 1.115-2.915 1.679 0.5856-3.534 3.084-7.054 6.338-8.746 2.082-1.115 4.75-1.604 7.665-1.604 8.498 0 12.66 6.578 12.66 20.05 0 10.43-6.923 25.43-15.08 32.49-8.667 7.618-16.83 11.23-16.91 11.23 0 0-1.002 0.5513-1.002 1.516 0 0.1629 0.07808 0.2381 0.07808 0.4009 0.2603 0.8019 1.002 0.9647 1.588 0.9647l0.2473-0.0752c0.1692 0 9.669-3.771 17.24-9.473 11.66-8.094 24.82-22.37 24.82-37.13 0-13.96-7.821-22.93-22.81-22.93m26.14 10.18c0 2.256 1.835 4.009 4.008 4.009 2.16 0 3.995-1.754 3.995-4.009 0-2.242-1.835-4.084-3.995-4.084-2.173 0-4.008 1.842-4.008 4.084m0 19.81c0 2.243 1.835 4.098 4.008 4.098 2.16 0 3.995-1.854 3.995-4.098 0-2.243-1.835-4.085-3.995-4.085-2.173 0-4.008 1.842-4.008 4.085m5.999-180.1c0-12.03-8.915-20.21-21.07-20.21-0.8329-4.811-1.588-9.623-2.329-14.04 8.745-8.909 14.9-19.01 14.9-31.68 0-7.38-2.33-13.23-3.748-16.13-1.991-4.085-4.412-6.979-5.83-6.979-0.5726 0-3.24 1.053-5.908 4.173-5.414 6.101-6.91 16.27-6.91 23.02 0 4.336 0.4164 8.257 1.835 17.33-0.09112 0-4.425 4.248-6.169 5.688-7.587 6.741-18.08 16.51-18.08 32.48 0 15.08 13.57 26.86 29.07 26.86 2.408 0 4.659-0.2381 6.663-0.5638 1.497 7.706 2.499 13.32 2.499 17.57 0 8.345-4.503 12.76-12.83 12.76-2.082 0-3.826-0.4009-3.917-0.4887-0.1562 0-0.3253-0.0752-0.3253-0.1504 0-0.1629 0.1692-0.2506 0.4164-0.3258 3.917-0.5638 7.821-3.771 7.821-8.896 0-4.336-3.41-8.909-9.656-8.909-5.752 0-9.5 4.573-9.5 9.859 0 5.3 4.164 12.28 15.41 12.28 10.75 0 15.99-5.864 15.99-16.13 0-3.12-0.4945-6.728-1.327-11.3-0.2473-1.604-0.6637-4.098-1.249-7.142 8.16-2.644 14.24-10.75 14.24-19.08m-25.65-65.68c0.8329-3.208 4.581-11.63 8.915-11.63 1.249 0 3.332 3.846 3.332 9.46 0 8.257-6.494 14.52-12.25 20.05-0.4945-3.208-0.9109-6.415-0.9109-9.695 0-3.044 0.3253-5.701 0.9109-8.182m2.499 82.93c-11.91 0-22.07-8.019-22.07-20.13 0-9.773 7.249-18.51 14.5-24.7 1.406-1.127 2.746-2.331 3.995-3.446 0.7418 4.323 1.418 8.019 1.913 11.39-7.587 2.08-12.74 9.859-12.74 17.32 0 5.701 4.581 13.39 11.24 13.39 0.6636 0 1.418-0.3257 1.418-1.127 0-0.639-0.7549-1.115-1.835-1.754-3.254-1.854-5.088-4.009-5.088-7.869 0-4.886 3.839-8.821 8.667-9.936l4.828 26.3c-1.666 0.4009-3.162 0.5638-4.828 0.5638m8.329-1.529c-1.744-9.536-3.995-22.29-4.581-25.82 8.407 0 12 5.613 12.74 9.473 0.09111 0.639 0.2473 1.516 0.2473 2.481 0 5.776-2.499 11.63-8.407 13.87m-3.253 42.03c0-2.969-2.824-4.248-5.57-4.248-3.501 0-6.923 2.08-6.923 5.688 0 1.529 0.5856 2.656 1.835 3.771-2.16 0.8019-4.412 2.406-4.412 4.899 0 2.644 2.499 4.411 6.169 4.411 4.49 0 7.652-2.406 7.652-5.864 0-1.842-0.8329-3.358-2.33-4.411 2.421-1.04 3.579-2.318 3.579-4.248m-5.154 3.208c-1.249-0.6389-1.588-0.8019-1.835-0.9647l-0.09112-0.0752c-1.327-0.7267-1.744-1.29-1.744-2.243 0-1.454 1.171-2.494 2.837-2.494s2.577 0.9647 2.577 2.644c0 1.29-0.4945 2.167-1.744 3.132m-3.175 9.623c-1.822 0-3.071-1.115-3.071-2.807 0-1.516 0.7418-2.882 2.16-3.684 0.3384 0.1629 0.4164 0.2381 0.6637 0.3132 1.002 0.4887 1.002 0.4887 1.171 0.6515 1.666 0.8771 2.251 1.679 2.251 2.807 0 1.516-1.34 2.719-3.175 2.719m-46.26 78.48v82.4h3.745v-82.4zm1.873 4.8e-4v82.4m-1.873-292.4v211.2h3.745v-211.2zm1.873-5.91e-4v211.2m-1.874 79.09v2.208l214.6-4e-5v-2.208zm0-20.05v2.206l214.6-4e-5v-2.206zm0-20.05v2.208l214.6-4e-5v-2.208zm0-20.05v2.208l214.6-4e-5v-2.208zm0-20.05v2.208l214.6-4e-5v-2.208zm0-129.8v2.208l214.6-4e-5v-2.208zm0-20.05v2.208l214.6-3e-5v-2.208zm0-20.05v2.208l214.6-4e-5v-2.208zm0-20.05v2.206l214.6-4e-5v-2.206zm0-20.05v2.208l214.6-4e-5v-2.208z"
        stroke-width=".8173"
      />
      {Object.entries(props.notes).map(([k, note]) => (
        <SingleNote key={k} note={note} />
      ))}
    </Svg>
  );
};
