import { FC } from "react";
import { useTheme } from "react-native-paper";
import Svg, { Circle, G, Path, Text } from "react-native-svg";
import { InitialNote, NoteName, Section } from "../types";

type Pentagram = "high" | "low";

const PREFER: Record<Section, Pentagram> = {
  soprano: "high",
  "mezzo-soprano": "high",
  contralto: "low",
  tenore: "high",
  baritono: "low",
  basso: "low",
};

const NOTE_MULTIPLIER: Record<NoteName, number> = {
  C: 0,
  D: 1,
  E: 2,
  F: 3,
  G: 4,
  A: 5,
  B: 6,
};

const getY = (note: InitialNote): number => {
  const penta = PREFER[note.section];
  const noteMultiplier = NOTE_MULTIPLIER[note.note.note];
  const onPenta = noteMultiplier * 9.6 + 19 + (note.note.octave - 1) * 71;
  const pos = penta === "high" ? 80 + onPenta : onPenta;

  return Math.round(pos);
};

const LINES = [20, 40, 161, 182, 199, 218, 241, 362, 382];

const SingleNote: FC<{ note: InitialNote }> = ({ note }) => {
  const theme = useTheme();
  const penta = PREFER[note.section];
  const y = getY(note);
  let lines: number[] = [];
  if (penta === "low" && y < 50) {
    lines.push(...LINES.filter((l) => l < 50 && l >= y));
  }
  if (penta === "low" && y > 140) {
    lines.push(...LINES.filter((l) => l > 140 && l <= y));
  }
  if (penta === "high" && y < 250) {
    lines.push(...LINES.filter((l) => l < 250 && l >= y));
  }
  if (penta === "high" && y > 320) {
    lines.push(...LINES.filter((l) => l > 320 && l <= y));
  }

  return (
    <G>
      {[...new Set(lines)].map((line, i) => (
        <Path
          key={i}
          stroke={theme.colors.onSurface}
          strokeWidth={2}
          d={`m133 ${400 - line}h35`}
        />
      ))}
      <Circle cx={150} cy={400 - y} r={10} fill={theme.colors.onSurface} />
      {/* <Text x={70} y={407 - y} fontSize={20} fill={theme.colors.onSurface}>
        {note.note.octave}
        {note.note.note}
        {y}
      </Text> */}
      <Text x={100} y={410 - y} fontSize={36} fill={theme.colors.onSurface}>
        {note.note.alteration}
      </Text>
    </G>
  );
};

export const Pentagram: FC<{ notes: InitialNote[] }> = (props) => {
  const theme = useTheme();
  return (
    <Svg viewBox="0 0 200 400" width={120} height={240}>
      <Path
        fill={theme.colors.onSurfaceDisabled}
        stroke="none"
        d="m47.02 374.9c0.3253-0.2472 0.5856-0.5856 0.5856-1.002 0-0.1692-0.09112-0.3253-0.09112-0.4164-0.07804-0.2473-4.997-21.66-30.65-21.66h-10.16v8.667c0 0.6636 0.4945 1.08 1.171 1.08h13.24c15.92 0 24.24 12.83 24.41 13.08 0.1562 0.3253 0.5726 0.4164 0.9109 0.4164 0.1692 0 0.4164-0.0911 0.5857-0.1692m0-349.9c-0.1692-0.07813-0.4164-0.1692-0.5857-0.1692-0.3383 0-0.7548 0.09112-0.9109 0.4164-0.1692 0.2473-8.498 13.08-24.41 13.08h-13.24c-0.6767 0-1.171 0.4164-1.171 1.08v8.667h10.16c25.65 0 30.57-21.41 30.65-21.66 0-0.09112 0.09112-0.2473 0.09112-0.4164 0-0.4164-0.2603-0.7548-0.5856-1.002m-40.32 18.39v313.1h9.37v-313.1zm59.27 214.6c-6.338 0-11.41 3.657-11.5 3.657-4.906 3.579-8.069 9.084-8.069 15.16 0 6.078 3.488 10.58 9.656 10.58 5.336 0 9.5-3.579 9.5-9.084 0-4.75-4.164-8.654-8.836-8.654-1.002 0-1.913 0.1562-2.668 0.4164-0.8329 0.3254-2.238 1.158-2.915 1.744 0.5856-3.67 3.084-7.327 6.338-9.084 2.082-1.158 4.75-1.666 7.665-1.666 8.498 0 12.66 6.832 12.66 20.82 0 10.83-6.923 26.41-15.08 33.75-8.667 7.912-16.83 11.66-16.91 11.66 0 0-1.002 0.5726-1.002 1.575 0 0.1692 0.07808 0.2473 0.07808 0.4164 0.2603 0.8329 1.002 1.002 1.588 1.002l0.2473-0.0781c0.1692 0 9.669-3.917 17.24-9.839 11.66-8.407 24.82-23.23 24.82-38.56 0-14.5-7.821-23.82-22.81-23.82m26.14 10.57c0 2.343 1.835 4.164 4.008 4.164 2.16 0 3.995-1.822 3.995-4.164 0-2.329-1.835-4.242-3.995-4.242-2.173 0-4.008 1.913-4.008 4.242m0 20.58c0 2.33 1.835 4.256 4.008 4.256 2.16 0 3.995-1.926 3.995-4.256s-1.835-4.243-3.995-4.243c-2.173 0-4.008 1.913-4.008 4.243m5.999-168.5c0-12.49-8.915-20.99-21.07-20.99-0.8329-4.997-1.588-9.995-2.329-14.58 8.745-9.253 14.9-19.74 14.9-32.9 0-7.665-2.33-13.74-3.748-16.75-1.991-4.243-4.412-7.249-5.83-7.249-0.5726 0-3.24 1.094-5.908 4.334-5.414 6.337-6.91 16.9-6.91 23.91 0 4.503 0.4164 8.576 1.835 18-0.09112 0-4.425 4.412-6.169 5.908-7.587 7.001-18.08 17.15-18.08 33.73 0 15.66 13.57 27.9 29.07 27.9 2.408 0 4.659-0.2473 6.663-0.5856 1.497 8.004 2.499 13.83 2.499 18.25 0 8.667-4.503 13.25-12.83 13.25-2.082 0-3.826-0.4164-3.917-0.5076-0.1562 0-0.3253-0.0782-0.3253-0.1562 0-0.1692 0.1692-0.2603 0.4164-0.3384 3.917-0.5856 7.821-3.917 7.821-9.24 0-4.503-3.41-9.253-9.656-9.253-5.752 0-9.5 4.75-9.5 10.24 0 5.505 4.164 12.75 15.41 12.75 10.75 0 15.99-6.091 15.99-16.75 0-3.24-0.4945-6.988-1.327-11.74-0.2473-1.666-0.6637-4.256-1.249-7.418 8.16-2.746 14.24-11.17 14.24-19.82m-25.65-68.22c0.8329-3.332 4.581-12.08 8.915-12.08 1.249 0 3.332 3.995 3.332 9.825 0 8.576-6.494 15.08-12.25 20.82-0.4945-3.332-0.9109-6.663-0.9109-10.07 0-3.162 0.3253-5.921 0.9109-8.498m2.499 86.13c-11.91 0-22.07-8.329-22.07-20.91 0-10.15 7.249-19.23 14.5-25.65 1.406-1.171 2.746-2.421 3.995-3.579 0.7418 4.49 1.418 8.329 1.913 11.83-7.587 2.16-12.74 10.24-12.74 17.99 0 5.921 4.581 13.91 11.24 13.91 0.6636 0 1.418-0.3383 1.418-1.171 0-0.6637-0.7549-1.158-1.835-1.822-3.254-1.926-5.088-4.164-5.088-8.173 0-5.075 3.839-9.162 8.667-10.32l4.828 27.32c-1.666 0.4164-3.162 0.5856-4.828 0.5856m8.329-1.588c-1.744-9.904-3.995-23.15-4.581-26.82 8.407 0 12 5.83 12.74 9.839 0.09111 0.6637 0.2473 1.575 0.2473 2.577 0 5.999-2.499 12.08-8.407 14.41m-3.253 43.65c0-3.084-2.824-4.412-5.57-4.412-3.501 0-6.923 2.16-6.923 5.908 0 1.588 0.5856 2.759 1.835 3.917-2.16 0.8329-4.412 2.499-4.412 5.088 0 2.746 2.499 4.581 6.169 4.581 4.49 0 7.652-2.499 7.652-6.091 0-1.913-0.8329-3.488-2.33-4.581 2.421-1.08 3.579-2.408 3.579-4.412m-5.154 3.332c-1.249-0.6636-1.588-0.8329-1.835-1.002l-0.09112-0.0781c-1.327-0.7548-1.744-1.34-1.744-2.33 0-1.51 1.171-2.59 2.837-2.59 1.666 0 2.577 1.002 2.577 2.746 0 1.34-0.4945 2.251-1.744 3.253m-3.175 9.995c-1.822 0-3.071-1.158-3.071-2.915 0-1.575 0.7418-2.993 2.16-3.826 0.3384 0.1692 0.4164 0.2473 0.6637 0.3253 1.002 0.5076 1.002 0.5076 1.171 0.6767 1.666 0.911 2.251 1.744 2.251 2.915 0 1.575-1.34 2.824-3.175 2.824m-46.26 62.97v85.58h3.745v-85.58zm1.873 5e-4v85.58m-1.873-285.2v200.8h3.745v-200.8zm1.873-6.13e-4v200.8m-1.874 82.14v2.293h167.8v-2.293zm0-20.82v2.291h167.8v-2.291zm0-20.82v2.293h167.8v-2.293zm0-20.82v2.293h167.8v-2.293zm0-20.82v2.293h167.8v-2.293zm0-116.3v2.293h167.8v-2.293zm0-20.82v2.293h167.8v-2.293zm0-20.82v2.293h167.8v-2.293zm0-20.82v2.291h167.8v-2.291zm0-20.82v2.293h167.8v-2.293z"
      />
      {props.notes.map((note, i) => (
        <SingleNote key={i} note={note} />
      ))}
    </Svg>
  );
};
